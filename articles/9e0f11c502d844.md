---
title: "ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã‚’å†èµ·å‹•ã™ã‚‹ã¨ã€Dockerã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã™ã‚‹SSH_AUTH_SOCKã®ãƒã‚¦ãƒ³ãƒˆãŒã†ã¾ãã„ã‹ãªã„"
emoji: "ğŸ³"
type: "tech"
topics:
  - "docker"
  - "ssh"
  - "dockercompose"
  - "devcontainer"
  - "devcontainercli"
published: true
published_at: "2024-08-02 20:40"
---

## äº‹è±¡

ä¸€åº¦ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã€ãã®ã‚ã¨ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³(Ubuntu)ã‚’å†èµ·å‹•ã€‚
å†èµ·å‹•å¾Œã«å†ã³ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã‚ˆã†ã¨ã™ã‚‹ã¨ãƒã‚¦ãƒ³ãƒˆã§ããªã„æ—¨ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚

>Error response from daemon: failed to create task for container: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: error during container init: error mounting "/tmp/ssh-ZyloNEwSAswN/agent.1551" to rootfs at "/tmp/ssh-ZyloNEwSAswN/agent.1551": mount /tmp/ssh-ZyloNEwSAswN/agent.1551:/tmp/ssh-ZyloNEwSAswN/agent.1551 (via /proc/self/fd/7), flags: 0x5000: not a directory: unknown: Are you trying to mount a directory onto a file (or vice-versa)? Check if the specified host path exists and is the expected type

## ç’°å¢ƒ
- Ubuntu24.04 (WSL)
- Docker (version 27.1.1)
- devcontainer cli (version 0.66.0)

### å‰æ

Ubuntuã§ `ssh-agent` ã‚’èµ·å‹•ã™ã‚‹ã¨ã‚½ã‚±ãƒƒãƒˆã¯ `/tmp/ssh-xxxxx/agent.xxx` ã«é…ç½®ã•ã‚Œã‚‹ã€‚ ã“ã®å ´æ‰€ã¯ `echo $SSH_AUTH_SOCK` ã§ç¢ºèªã§ãã‚‹ã€‚

`docker compose` ã‚’ç”¨ã„ã¦ã‚³ãƒ³ãƒ†ãƒŠä¸Šã‚’ç«‹ã¡ä¸Šã’ã‚‹éš›ã€Ubuntuã® `ssh-agent` ã‚’å¼•ãç¶™ãã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«envã¨volumesã‚’è¨­å®šã™ã‚‹ï¼ˆã“ã¨ãŒãƒãƒƒãƒˆã§æ•£è¦‹ã•ã‚ŒãŸï¼‰ã€‚

docker-compose.yml
```yaml
services:
  app:
    build:
      context: .
      dockerfile: ./Dockerfile
    environment:
      - SSH_AUTH_SOCK=$SSH_AUTH_SOCK
    volumes:
      - $SSH_AUTH_SOCK:$SSH_AUTH_SOCK
    tty: true
```

ç§ã¯å®Ÿéš›ã«ã¯ `docker compose` ã‚’ä½¿ã£ã¦ãŠã‚‰ãšã€`devcontainer cli` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã€‚
.devcontainer/devcontainer.json
```json
{
        "name": "Ubuntu",
        "dockerComposeFile": "docker-compose.yml",
        "service": "app"
}
```

å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã€‚ï¼ˆdocker compose up ã¨ docker compose execã¨åŒã˜ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ï¼‰
```bash
$ devcontainer up  --workspace-folder .
$ devcontainer exec --workspace-folder .  bash
```

## åŸå› 
Ubuntuå†èµ·å‹•å¾Œã« `ssh-agent` ã‚’èµ·å‹•ã™ã‚‹ã¨ã€å‰å›ã¨ã¯ç•°ãªã‚‹ä½ç½®ã«ã‚½ã‚±ãƒƒãƒˆãŒé…ç½®ã•ã‚Œã‚‹ã€‚ï¼ˆ`/tmp/ssh-xxxxx/agent.xxx`ã¨ã„ã†å½¢å¼ãªã®ã§ï¼‰

ãã—ã¦docker-compose.ymlã«è¨˜è¼‰ã—ãŸvolumesã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«å›ºå®šã•ã‚Œã‚‹ãŸã‚ã€ã‚ã¨ã‹ã‚‰å¤‰ãˆã‚‹ã“ã¨ã¯ã§ããªã„ã€‚

ãã®ãŸã‚Ubuntuå†èµ·å‹•å¾Œã«ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ã«å›ºå®šã—ãŸï¼‰å†èµ·å‹•å‰ã®ã‚½ã‚±ãƒƒãƒˆã‚’ãƒã‚¦ãƒ³ãƒˆã—ã‚ˆã†ã¨è©¦ã¿ã¦å¤±æ•—ã™ã‚‹ã€‚

## å¯¾å‡¦æ³•

éµæƒ…å ±ã‚’ã‚³ãƒ³ãƒ†ãƒŠã® ~/.ssh/ ã«æ›¸ãè¾¼ã‚“ã ã‚Šã€ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚Šç›´ã—ãŸã‚Šã™ã‚‹ã“ã¨ã§è§£æ±ºã¯ã§ãã‚‹ã‚‰ã—ã„ã€‚

åˆ¥ã®æ–¹æ³•ã¯ãªã„ã‹ã¨æ¢ã—ã¦ã¿ãŸã¨ã“ã‚ã€ã©ã†ã‚„ã‚‰ `ssh-agent` ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚½ã‚±ãƒƒãƒˆã®é…ç½®å ´æ‰€ã‚’è¨­å®šã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‚‰ã—ã„ã€‚

`man ssh-agent`ã®çµæœ
```
       -a bind_address
               Bind   the   agent    to    the    Unix-domain    socket    bind_address.     The    default    is
               $TMPDIR/ssh-XXXXXXXXXX/agent.<ppid>.
```

ã“ã‚Œã‚’ä½¿ãˆã°ã‚½ã‚±ãƒƒãƒˆã®é…ç½®å ´æ‰€ãŒå›ºå®šã•ã‚Œã‚‹ã®ã§å•é¡ŒãŒè§£æ±ºã§ãã‚‹ã€‚

å…·ä½“çš„ã«ã¯ `.bash_profile` ã«ä¸‹ã®ã‚ˆã†ã«è¨˜è¼‰ã™ã‚Œã°è‰¯ã„ã€‚
```bash
$ cat ~/.bash_profile
if [ -z "$SSH_AUTH_SOCK" ]; then
    # Check for a currently running instance of the agent
    RUNNING_AGENT="`ps -ax | grep 'ssh-agent -s' | grep -v grep | wc -l | tr -d '[:space:]'`"
    if [ "$RUNNING_AGENT" = "0" ]; then
         mkdir -p /tmp/ssh
         # Launch a new instance of the agent
         ssh-agent -s -a /tmp/ssh/agent.sock &> $HOME/.ssh/ssh-agent
    fi
    eval `cat $HOME/.ssh/ssh-agent` >& /dev/null
fi

if [ -f ~/.bashrc ] ; then
    . ~/.bashrc
fi
```












